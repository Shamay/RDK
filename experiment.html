<!DOCTYPE html>
<html>
  <head>
    <!--

		RDK plugin for JsPsych
		----------------------

		This code was created in the Consciousness and Metacognition Lab at UCLA,
		under the supervision of Brian Odegaard and Hakwan Lau

		----------------------

		Copyright (C) 2017  Sivananda Rajananda

		This program is free software: you can redistribute it and/or modify
		it under the terms of the GNU General Public License as published by
		the Free Software Foundation, either version 3 of the License, or
		(at your option) any later version.

		This program is distributed in the hope that it will be useful,
		but WITHOUT ANY WARRANTY; without even the implied warranty of
		MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
		GNU General Public License for more details.

		You should have received a copy of the GNU General Public License
		along with this program.  If not, see <http://www.gnu.org/licenses/>.

		-->

    <title>Dot Motion Task</title>
      <script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
      <script src="jspsych-6.0.1/jspsych.js"></script>
      <script src="jspsych-6.0.1/jspsych-6.0.1/plugins/jspsych-html-keyboard-response.js"></script>
      <script src="jspsych-6.0.1/jspsych-6.0.1/plugins/jspsych-instructions.js"></script>
      <script src="jspsych-6.0.1/jspsych-6.0.1/plugins/jspsych-dotmotion.js"></script>
      <link href="jspsych-6.0.1/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

    //The main timeline to be fed into jsPsych.init
    var timeline = [];

    //Loading config file synchronously
    var config;

    $.ajax({
      url: 'config.json',
      async: false,
      dataType: 'json',
      success: function (response) {
        config = response[0]
      }
    });

    /* define instructions block */
    var instructions = {
      type: 'instructions',
      pages: [
          'Welcome to the experiment. Click next to begin.',
          'This is the second page of instructions.',
          'This is the final page.'
      ],
      show_clickable_nav: true,
      post_trial_gap: 1000
    };
    timeline.push(instructions);

    //---------Create trials---------

		//convert vertical/horizontal to degree notation
		var degrees;
		if (config.coherentDirection ==  'verticalAxis'){
			degrees = 270
		}else if (config.coherentDirection ==  "horizontalAxis") {
			degrees = 180
		}

		// randomize either coherent direction or colors
		var randomizer = function(method) {
  		rand = Math.floor(Math.random() * 2);
			if(method == "motion"){
				return rand;
			}else if(method == "color"){
				if(rand == 0){
					return "blue"
				}else if(rand == 1){
					return "red"
				}
			}
		}

    //Create an array of all the different trials we want to run in the test phase
    var test_stimuli = [
      {// Motion trial 1
        task: 'direction',
        correct_response: 'a', //The correct answer for Condition 2
				coherent_direction: degrees, //The coherent direction for Condition 1 (dots move down/left)
				coherent_color: randomizer("color") // randomize coherent color
			},
			{// Motion trial 2
				task: 'direction',
        correct_response: 'l', //The correct answer for Condition 2
				coherent_direction: degrees - 180, //The coherent direction for Condition 2 (dots move up/right)
				coherent_color: randomizer("color") // randomize coherent color
			},
      {// Color Trial 1
			  task: 'color',
        correct_response: 'a', //The correct answer for Condition 3
				coherent_direction: degrees - 180 * randomizer("motion"), // randomize coherent direction
				coherent_color: "red" //The coherent color for Condition 3
			},
			{// Color Trial 2
				task: 'color',
        correct_response: 'l', //The correct answer for Condition 4
				coherent_direction: degrees - 180 * randomizer("motion"),  // randomize coherent direction
				coherent_color: "blue" //The coherent color for Condition 4
			}
    ]

    var fixation = {
      type: 'html-keyboard-response',
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000,
    }

    var test = {
      type: "dotmotion",
      RDK_type: 3, //The type of RDK used
      choices: ['a', 'l'], //Choices available to be keyed in by participant

      task: jsPsych.timelineVariable('task'),
      correct_choice: jsPsych.timelineVariable('correct_response'),
      coherent_direction: jsPsych.timelineVariable('coherent_direction'),
      coherent_color: jsPsych.timelineVariable('coherent_color'),

      number_of_dots: config.number_of_dots, //Total number of dots in the aperture

      response_ends_trial: config.response_ends_trial, //Whether response ends the trial or not
			fill_ITT: config.fill_ITT, // Whether to standardize trial length or not, condition on response_ends_trial being true
			trial_duration: config.trial_duration, //Duration of each trial in ms
      post_trial_gap: config.inter_trial_interval, //The Inter Trial Interval.
      fixation_cross: config.fixation_cross, // Whether or not to include fixation cross

			motionCoherence: config.motionCoherence,
			colorCoherence: config.colorCoherence

    }

    var test_procedure = {
      timeline: [fixation, test],
      timeline_variables: test_stimuli,
      randomize_order: true,
      repetitions: 1
    }
    timeline.push(test_procedure);

		//---------Run the experiment---------

		//Initiate the experiment
		jsPsych.init({
			timeline: timeline,
			on_finish: function(){ //Execute this when the experiment finishes
				//jsPsych.data.localSave('testSave.csv', 'csv'); //Save the data locally in a .csv file
				jsPsych.data.displayData(); //Display the data onto the browser screen
			}
		})

  </script>
  </html>
