<!DOCTYPE html>
<html>
  <head>
    <!--

		RDK plugin for JsPsych
		----------------------

		This code was created in the Consciousness and Metacognition Lab at UCLA,
		under the supervision of Brian Odegaard and Hakwan Lau

		----------------------

		Copyright (C) 2017  Sivananda Rajananda

		This program is free software: you can redistribute it and/or modify
		it under the terms of the GNU General Public License as published by
		the Free Software Foundation, either version 3 of the License, or
		(at your option) any later version.

		This program is distributed in the hope that it will be useful,
		but WITHOUT ANY WARRANTY; without even the implied warranty of
		MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
		GNU General Public License for more details.

		You should have received a copy of the GNU General Public License
		along with this program.  If not, see <http://www.gnu.org/licenses/>.

		-->

    <title>Dot Motion Task</title>
      <script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
      <script src="jspsych-6.0.1/jspsych.js"></script>
      <script src="jspsych-6.0.1/jspsych-6.0.1/plugins/jspsych-html-keyboard-response.js"></script>
      <script src="jspsych-6.0.1/jspsych-6.0.1/plugins/jspsych-instructions.js"></script>
      <script src="jspsych-6.0.1/jspsych-6.0.1/plugins/jspsych-dotmotion.js"></script>
      <link href="jspsych-6.0.1/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  <body></body>
  <script>

    //The main timeline to be fed into jsPsych.init
    var timeline = [];

    //Loading config file synchronously
    var config;

    $.ajax({
      url: 'config.json',
      async: false,
      dataType: 'json',
      success: function (response) {
        config = response[0]
      }
    });

    /* define instructions block */
    var instructions = {
      type: 'instructions',
      pages: [
          'Welcome to the experiment. Click next to begin.',
          //'This is the second page of instructions.',
          //'This is the final page.'
      ],
      show_clickable_nav: true,
      post_trial_gap: 1000
    };
    timeline.push(instructions);

    //---------Create trials---------

		//convert vertical/horizontal to degree notation
		var degrees;
		if (config.coherentDirection ==  'verticalAxis'){
			degrees = 270
		}else if (config.coherentDirection ==  "horizontalAxis") {
			degrees = 180
		}

    //Create an array of all the different trials we want to run in the test phase
    var motion_stimuli = [
      {// Motion trial 1
        task: 'direction',
        correct_response: 'a', //The correct answer for Condition 2
				coherent_direction: degrees, //The coherent direction for Condition 1 (dots move down/left)
				coherent_color: function(){ // randomize coherent color
          return jsPsych.randomization.sampleWithoutReplacement(["red","blue"], 1)[0];
        }(),
        cue_shape: function(){ // randomize cue shape
          return jsPsych.randomization.sampleWithoutReplacement([4,2], 1)[0];
        }()
			},
			{// Motion trial 2
				task: 'direction',
        correct_response: 'l', //The correct answer for Condition 2
				coherent_direction: degrees - 180, //The coherent direction for Condition 2 (dots move up/right)
				coherent_color: function(){ // randomize coherent color
          return jsPsych.randomization.sampleWithoutReplacement(["red","blue"], 1)[0];
        }(),
        cue_shape: function(){
          return jsPsych.randomization.sampleWithoutReplacement([4,2], 1)[0];
        }()
			}
    ]
    var color_stimuli = [
      {// Color Trial 1
			  task: 'color',
        correct_response: 'a', //The correct answer for Condition 3
        coherent_color: "red", //The coherent color for Condition 3
				coherent_direction: degrees - 180 * function(){ // randomize coherent dorection
          return jsPsych.randomization.sampleWithoutReplacement([0,1], 1)[0];
        }(),
        cue_shape: function(){
          return jsPsych.randomization.sampleWithoutReplacement([1,3], 1)[0];
        }()
			},
			{// Color Trial 2
				task: 'color',
        correct_response: 'l', //The correct answer for Condition 4
        coherent_color: "blue", //The coherent color for Condition 4
				coherent_direction: degrees - 180 * function(){ // randomize coherent dorection
          return jsPsych.randomization.sampleWithoutReplacement([0,1], 1)[0];
        }(),
        cue_shape: function(){
          return jsPsych.randomization.sampleWithoutReplacement([1,3], 1)[0];
        }()
			}
    ]

    var fixation = {
      type: 'html-keyboard-response',
      stimulus: function(){
        if(config.fixation_cross){ // Whether or not to include fixation cross)
          return '<div style="font-size:60px;">+</div>';
        }else{
          return '';
        }
      }(),
      choices: jsPsych.NO_KEYS,
      trial_duration: config.inter_trial_interval,
      on_start: function(fixation){ // dynamically change inter_trial_interval
        // get data from previous trial
        var data = jsPsych.data.get().last(1).values()[0];
        if(data.response_ends_trial && data.fill_ITT && data.rt != -1){
  				fixation.trial_duration += Math.floor(data.trial_duration - data.rt);
  			}
      }
    }

    var test = {
      type: "dotmotion",
      RDK_type: 3, //The type of RDK used
      choices: ['a', 'l'], //Choices available to be keyed in by participant

      task: jsPsych.timelineVariable('task'),
      correct_choice: jsPsych.timelineVariable('correct_response'),
      coherent_direction: jsPsych.timelineVariable('coherent_direction'),
      coherent_color: jsPsych.timelineVariable('coherent_color'),
      cue_shape: jsPsych.timelineVariable('cue_shape'),

      number_of_dots: config.number_of_dots, //Total number of dots in the aperture

      response_ends_trial: config.response_ends_trial, //Whether response ends the trial or not
			fill_ITT: config.fill_ITT, // Whether to standardize trial length or not, condition on response_ends_trial being true
			trial_duration: config.trial_duration, //Duration of each trial in ms

			motionCoherence: config.motionCoherence,
			colorCoherence: config.colorCoherence

    }

    // generate sequence
    var seq = config.sequence;
    for (i in seq){
      type = seq[i].split('')[0];
      reps = seq[i].split('')[1];
      var test_procedure;
      if(type == 'M'){
        test_procedure = {
          timeline: [fixation, test],
          timeline_variables: motion_stimuli,
          randomize_order: true,
          repetitions: reps,
          sample: {
            type: "without-replacement",
            size: 1,
          }
        }
      }else if(type == 'C'){
        test_procedure = {
          timeline: [fixation, test],
          timeline_variables: color_stimuli,
          randomize_order: true,
          repetitions: reps,
          sample: {
            type: "without-replacement",
            size: 1,
          }
        }
      }
      timeline.push(test_procedure);
    }

		//---------Run the experiment---------

		//Initiate the experiment
		jsPsych.init({
			timeline: timeline,
			on_finish: function(){ //Execute this when the experiment finishes
				//jsPsych.data.localSave('testSave.csv', 'csv'); //Save the data locally in a .csv file
				jsPsych.data.displayData(); //Display the data onto the browser screen
			}
		})

  </script>
  </html>
